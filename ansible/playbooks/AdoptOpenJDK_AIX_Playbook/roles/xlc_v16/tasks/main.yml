###################
# IBM XL C 16.1.0 #
###################
---
- name: Checking for xlC16 installed as 'licensed' LPP
  stat:
    path: /usr/lpp/xlCcmp.16.1.0.license
  register: xlc16
  tags: xlc16

- name: Announce skip of download and installation
  debug:
    msg: "xlc16 installed, skipping download and installation"
  when: xlc16.stat.isdir is defined and xlc.stat.isdir
  tags: xlc16

- name: Vendor File processing
  block:
    - name: Transfer and Extract XLC16
      unarchive:
        src: /Vendor_Files/aix/XLC/XL_C_Cpp_FOR_AIX_V16.1_EMG.tar.Z
        dest: /tmp
        remote_src: no
      register: _images
      ignore_errors: yes

    - name: Install IBM XLC16 - installp
      command: installp -aXYg -e /tmp/usr/install.log -d /tmp/usr/sys/inst.images all
      register: _installp
      ignore_errors: yes
      when: _images.skipped is defined and _images.skipped == false

    - debug: msg='Error messages from the installp command can be ignored.'
      when: _installp is defined

    - name: Clean XLC16 tmp files
      file:
        path: /tmp/usr
        state: absent
      when: _images.skipped == false
  when: xlc16.stat.islnk is not defined
  tags: [xlc16, vendor_files]

- name: TestIBM XLC16
  command: /opt/IBM/xlC/16.1.0/bin/xlc -qversion
  register: xlc16_qversion
  ignore_errors: yes
  changed_when: false
  tags: xlc16

- name: Display XLC16 qversion information
  debug:
    msg: "{{ xlc16_qversion.stdout }}"
  when: xlc16_qversion.failed == false
  tags: xlc16

- debug:
    msg: "{{ xlc16_qversion.cmd }} returns {{ xlc16_qversion.msg }}"
  when: xlc16_qversion.failed == true
  tags: xlc16
