---
########################
# Include OS variables #
########################
- name: Include OS variables
  include_vars: "../vars/main.yml"
  tags: main

##########
# cygwin #
##########
- name: Test if Cygwin is already installed
  win_stat:
    path: 'C:\cygwin64'
  register: cygwin_installed
  tags: cygwin

- name: Retrieve cygwin cache from ci.adoptopenjdk.net
  win_get_url:
    url: https://ci.adoptopenjdk.net/userContent/winansible/cygwin64.tar.gz
    dest: C:/temp/cygwin64.tar.gz
    checksum: 8f8b1d7d00233e384e725390c4018941fe7125290b94ecc0eeb3cf6684b4ce23
    checksum_algorithm: sha256
  when: (not cygwin_installed.stat.exists)
  tags: cygwin

- name: Retrieve cygwin toolset from ci.adoptopenjdk.net
  win_get_url:
    url: https://ci.adoptopenjdk.net/userContent/winansible/cygwin64/bin/*zip*/bin.zip
    dest: C:/temp/cyg_toolset.zip
    checksum: 39a94bb8ac6e5810437d7928381943d9f3a811729ad05d2967a5a7da8bce5b7d
    checksum_algorithm: sha256
  when: (not cygwin_installed.stat.exists)
  tags: cygwin

- name: Use cygwin 'tar' and 'pigz' to extract cygwin cache
  win_shell: |
    Expand-Archive -LiteralPath C:\temp\cyg_toolset.zip -DestinationPath C:\temp;
    $env:path="C:\temp\bin;$env:path"
    cd C:\
    tar --force-local -I pigz -xf C:\temp\cygwin64.tar.gz
  args:
    executable: powershell
  when: (not cygwin_installed.stat.exists)
  tags: cygwin

- name: Change git config to not replace Line endings
  win_shell: "C:/cygwin64/bin/git config --system core.autocrlf false"
  tags: cygwin

- name: Remove c:\cygwin64\bin from the path if it exists
  win_path:
    name: PATH
    elements:
      - 'C:\cygwin64\bin'
    scope: machine
    state: absent
  when: (not cygwin_installed.stat.exists)
  tags: cygwin

# NOTE: This construct is because an SQL Server entry is being added to
# the path which has an erroneous quote in it which causes problems for SETX
# See https://github.com/AdoptOpenJDK/openjdk-infrastructure/issues/1401
- name: Remove speech mark from the %PATH%
  win_shell: 'setx /M PATH "%PATH:\"=%"'
  args:
    executable: cmd
  when: (not cygwin_installed.stat.exists)
  tags:
    - cygwin

- name: Add c:\cygwin64\bin to front of %PATH%
  win_shell: 'setx /M PATH "C:\cygwin64\bin;%PATH%"'
  args:
    executable: cmd
  when: (not cygwin_installed.stat.exists)
  tags:
    - cygwin

- name: Reboot machine for PATH changes to take effect
  win_reboot:
    reboot_timeout: 1800
  when: (not cygwin_installed.stat.exists)
  tags: cygwin
