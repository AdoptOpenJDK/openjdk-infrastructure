---
############
# Security #
############
- name: Ensure 'no-agent-forwarding' doesn't exist in root's authorized_key file
  lineinfile:
    path: /root/.ssh/authorized_key
    state: absent
    regexp: '^no-agent-forwarding'
  when:
    - Security == "Enabled"
  tags: security
  
- name: Ensure keybox's ssh key is applied to root's authorized_key file
  authorized_key:
    user: root
    state: present
    key: "{{ lookup('file', '{{ Keybox_SSHKey }}') }}"
  when:
    - Security == "Enabled"
  tags: security
  
- name: Ensure security settings are applied to sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    state: present
    line: " {{ item }} "
  with_items:
    - PermitRootLogin without-password
    - PasswordAuthentication no
    - ChallengeResponseAuthentication no
  when:
    - Security == "Enabled"
  tags: security

- name: Restart ssh service
  service:
    name: ssh
    state: restarted
    enabled: yes
  when:
    - Security == "Enabled"
  tags: security

- name: Account policy - expire date
  command: chage -E -1 "{{ item }}"
  ignore_errors: yes
  with_items:
    - root
    - jenkins
    - nagios
    - zeus
  when:
    - Security == "Enabled"
  tags: security

- name: Account policy - max days
  command: chage -M -1 "{{ item }}"
  ignore_errors: yes
  with_items:
    - root
    - jenkins
    - nagios
    - zeus
  when:
    - Security == "Enabled"
  tags: security
